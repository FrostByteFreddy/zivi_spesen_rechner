{#
/**
 * @file
 * Compact PDF template for Spesenabrechnung.
 */
#}
<div style="font-family: 'DejaVu Sans', Helvetica, Arial, sans-serif; color: #1a1a1a; line-height: 1.4; max-width: 100%; margin: 0 auto; box-sizing: border-box;">
  <style>
    * { font-family: 'DejaVu Sans', Helvetica, Arial, sans-serif !important; }
  </style>

  {# Title #}
  <div style="font-size: 22px; font-weight: 900; color: #0f172a; margin-bottom: 20px; padding-bottom: 8px;">
    {% set german_months = {
      1: 'Januar', 2: 'Februar', 3: 'MÃ¤rz', 4: 'April', 5: 'Mai', 6: 'Juni',
      7: 'Juli', 8: 'August', 9: 'September', 10: 'Oktober', 11: 'November', 12: 'Dezember'
    } %}
    {% set month_index = node.field_date_range.value|date('n') %}
    {% set year = node.field_date_range.value|date('Y') %}
    <strong>Spesenabrechnung {{ german_months[month_index] }} {{ year }}</strong>
  </div>

  {# Two Column Layout #}
  <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
    <tr>
      <td style="vertical-align: top; width: 50%; padding-right: 15px;">
        {# Left: Period Info #}
        <div style="font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 5px;">
          <strong>Abrechnungszeitraum</strong>
        </div>
        <div style="font-size: 13px; font-weight: 700; color: #0f172a; margin-bottom: 4px;">
          <strong>{{ node.field_date_range.value|date('d.m.Y') }} â€“ {{ node.field_date_range.end_value|date('d.m.Y') }}</strong>
        </div>
        {% set start_date = node.field_date_range.value|date('U') %}
        {% set end_date = node.field_date_range.end_value|date('U') %}
        {% set total_days = ((end_date - start_date) / 86400)|round(0, 'ceil') + 1 %}
        <div style="font-size: 11px; color: #334155;">
          <strong style="font-weight: normal;">Anrechenbare Tage: </strong>
          <strong style="font-weight: 700;">{{ total_days }}</strong>
        </div>
      </td>
      
      <td style="vertical-align: top; width: 50%;">
        {# Right: Internal Stamp #}
        <table style="width: 100%; border-collapse: collapse; border: 1px solid #cbd5e1; font-size: 9px;">
          <tr>
            <td style="padding: 6px; border-bottom: 1px solid #cbd5e1; background-color: #f8fafc; font-weight: 600;" colspan="2">
              <strong>Beschrieb</strong>
            </td>
          </tr>
          <tr>
            <td style="padding: 6px; border-bottom: 1px solid #cbd5e1; border-right: 1px solid #cbd5e1; width: 50%;">
              <strong>KST</strong>
            </td>
            <td style="padding: 6px; border-bottom: 1px solid #cbd5e1; width: 50%;">
              <strong>Konto</strong>
            </td>
          </tr>
          <tr>
            <td style="padding: 6px; border-bottom: 1px solid #cbd5e1; border-right: 1px solid #cbd5e1;">
              <strong>Visum</strong>
            </td>
            <td style="padding: 6px; border-bottom: 1px solid #cbd5e1;">
              <strong>Vis.GL</strong>
            </td>
          </tr>
          <tr>
            <td style="padding: 6px; border-right: 1px solid #cbd5e1;">
              <strong>Geb.</strong>
            </td>
            <td style="padding: 6px;">
              <strong>Bez.</strong>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>

  {# Person Info #}
  <div style="margin-bottom: 20px;">
    <div style="font-size: 11px; color: #334155; white-space: pre-line;">
      <strong style="display: inline-block; margin-bottom: 5px; font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase;">Zivildienstleistender</strong>
      <strong>{{ node.getOwner().field_full_name.value|default(node.getOwner().getDisplayName()) }}</strong>
      <strong style="font-weight: normal;">{{ node.getOwner().field_address.value|default('Keine Adresse hinterlegt') }}</strong>
      <strong style="font-weight: normal;">{{ node.getOwner().field_iban.value|default('Keine IBAN hinterlegt') }}</strong>
    </div>
  </div>

  {# Expenses Table #}
  <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11px;">
    <thead>
      <tr style="border-bottom: 2px solid #0f172a;">
        <th style="padding: 10px 5px; text-align: left; font-weight: 800; font-size: 10px; text-transform: uppercase; color: #64748b;"><strong style="font-weight: normal;">Bezeichnung</strong></th>
<th style="padding: 10px 5px; text-align: right; font-weight: 800; font-size: 10px; text-transform: uppercase; color: #64748b; width: 70px;"><strong style="font-weight: normal;">Satz</strong></th>
<th style="padding: 10px 5px; text-align: right; font-weight: 800; font-size: 10px; text-transform: uppercase; color: #64748b; width: 50px;"><strong style="font-weight: normal;">Anz.</strong></th>
<th style="padding: 10px 5px; text-align: right; font-weight: 800; font-size: 10px; text-transform: uppercase; color: #64748b; width: 90px;"><strong style="font-weight: normal;">Betrag</strong></th>
      </tr>
    </thead>
    <tbody>
      {% for item in node.field_expense_items %}
        {% set paragraph = item.entity %}
        <tr style="border-bottom: 1px solid #e2e8f0;">
          <td style="padding: 12px 5px;">
            <div style="font-weight: 700; color: #0f172a; font-size: 12px;">{{ paragraph.field_item_type.value }}</div>
            {% if paragraph.field_comment.value %}
              <div style="font-size: 10px; color: #64748b; margin-top: 2px;">{{ paragraph.field_comment.value }}</div>
            {% endif %}
          </td>
          <td style="padding: 12px 5px; text-align: right; color: #334155; vertical-align: top;">
            {{ paragraph.field_rate.value|number_format(2, '.', "'") }}
          </td>
          <td style="padding: 12px 5px; text-align: right; color: #334155; vertical-align: top;">
            {{ paragraph.field_quantity.value|number_format(0) }}
          </td>
          <td style="padding: 12px 5px; text-align: right; font-weight: 700; color: #0f172a; vertical-align: top;">
            CHF {{ paragraph.field_total_amount.value|number_format(2, '.', "'") }}
          </td>
        </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="2" style="padding: 20px 5px; text-align: right; font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase;"></td>
        <td colspan="2" style="padding: 20px 0; text-align: right;">
          <strong style="font-size: 16px; color: #0f172a;">CHF {{ node.field_total_sum.value|number_format(2, '.', "'") }}</strong>
        </td>
      </tr>
    </tfoot>
  </table>

  {# Footer #}
  <div style="font-size: 9px; color: #64748b; text-align: center; border-top: 1px solid #cbd5e1; padding-top: 10px;">
    Diese Abrechnung wurde elektronisch erstellt. GemÃ¤ÃŸ Verordnung des EVD Ã¼ber Geldleistungen zugunsten zivildienstleistender Personen.
  </div>

  {# Receipts #}
  {% set receipts = [] %}
  {% set standard_types = ['Taschengeld', 'Morgenessen', 'Mittagessen', 'Nachtessen'] %}
  
  {% for item in node.field_expense_items %}
    {% set paragraph = item.entity %}
    {% if paragraph.field_receipt.entity.fid.value and paragraph.field_item_type.value not in standard_types %}
      {% set receipts = receipts|merge([paragraph]) %}
    {% endif %}
  {% endfor %}

  {% if receipts|length > 0 %}
    <div style="page-break-before: always; padding-top: 30px;">
      <div style="font-size: 18px; font-weight: 900; color: #0f172a; margin-bottom: 20px; padding-bottom: 8px;">
        <strong>Belege</strong>
      </div>
      
      {% for item in receipts %}
        <div style="margin-bottom: 30px; page-break-inside: avoid; border: 1px solid #cbd5e1; padding: 15px;">
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
            <tr>
              <td style="vertical-align: middle;">
                <strong style="font-size: 13px; font-weight: 700;">{{ item.field_item_type.value }}</strong>
              </td>
              <td style="vertical-align: middle; text-align: right;">
                <strong style="font-size: 13px; font-weight: 700;">CHF {{ item.field_total_amount.value|number_format(2, '.', "'") }}</strong>
              </td>
            </tr>
          </table>
          
          {% if item.field_receipt.entity.filemime.value starts with 'image/' %}
            <div style="text-align: center; background-color: #f8fafc; padding: 10px; border: 1px solid #e2e8f0;">
              <img src="{{ file_url(item.field_receipt.entity.uri.value) }}" style="max-width: 100%; max-height: 400px;">
            </div>
          {% else %}
            <div style="padding: 30px; border: 2px dashed #cbd5e1; text-align: center; background-color: #f8fafc;">
              <div style="font-size: 24px; margin-bottom: 8px;">ðŸ“„</div>
              <div style="font-size: 11px; font-weight: 600;">{{ item.field_receipt.entity.filename.value }}</div>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% endif %}
</div>