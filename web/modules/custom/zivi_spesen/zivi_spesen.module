<?php

use Drupal\node\NodeInterface;
use Drupal\paragraphs\Entity\Paragraph;
use Drupal\Core\Datetime\DrupalDateTime;
use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_theme().
 */
function zivi_spesen_theme() {
  return [
    'dashboard_admin' => [
      'variables' => [
        'items' => [],
      ],
    ],
    'dashboard_zivi' => [
      'variables' => [
        'items' => [],
      ],
    ],
    'page__user__login' => [
      'template' => 'page--user--login',
      'variables' => [
        'page' => [],
      ],
    ],
    'page__user__logout__confirm' => [
      'template' => 'page--user--login', // Reuse the login template
      'variables' => [
        'page' => [],
      ],
    ],
    'page__dashboard' => [
      'template' => 'page--dashboard',
      'variables' => ['page' => NULL],
    ],
    'expense_report_form' => [
      'render element' => 'form',
    ],
    'node__spesenabrechnung__pdf' => [
      'base hook' => 'node',
    ],
  ];
}

/**
 * Implements hook_page_attachments().
 */
function zivi_spesen_page_attachments(array &$attachments) {
  $attachments['#attached']['library'][] = 'zivi_spesen/app_styling';
}

/**
 * Implements hook_preprocess_page().
 */
function zivi_spesen_preprocess_page(&$variables) {
  // We don't need to unset regions here anymore if we are using custom templates that don't print them.
  // But keeping it doesn't hurt as a safeguard.
  $route_name = \Drupal::routeMatch()->getRouteName();
  
  // Target Login page and Dashboard
  // Target Login page, Logout Confirm, Dashboard, Add Report, and Edit Report
  if ($route_name === 'user.login' || $route_name === 'user.logout.confirm' || $route_name === 'zivi_spesen.dashboard' || $route_name === 'zivi_spesen.add_report' || $route_name === 'zivi_spesen.edit_report') {
    // Remove regions
    unset($variables['page']['header']);
    unset($variables['page']['primary_menu']);
    unset($variables['page']['secondary_menu']);
    unset($variables['page']['breadcrumb']);
    unset($variables['page']['highlighted']);
    unset($variables['page']['help']);
    unset($variables['page']['footer']);
    unset($variables['page']['bottom']);
  }
}

/**
 * Implements hook_theme_suggestions_page_alter().
 */
function zivi_spesen_theme_suggestions_page_alter(array &$suggestions, array $variables) {
  $route_name = \Drupal::routeMatch()->getRouteName();
  if ($route_name === 'user.login') {
    $suggestions[] = 'page__user__login';
  }
  if ($route_name === 'user.logout.confirm') {
    $suggestions[] = 'page__user__logout__confirm';
  }
  if ($route_name === 'zivi_spesen.dashboard') {
    $suggestions[] = 'page__dashboard';
  }
  if ($route_name === 'zivi_spesen.add_report' || $route_name === 'zivi_spesen.edit_report') {
    $suggestions[] = 'page__dashboard'; // Use the same dashboard shell
  }
}

/**
 * Implements hook_theme_suggestions_node_alter().
 */
function zivi_spesen_theme_suggestions_node_alter(array &$suggestions, array $variables) {
  $node = $variables['elements']['#node'];
  if ($node->getType() === 'spesenabrechnung' && $variables['elements']['#view_mode'] === 'pdf') {
    $suggestions[] = 'node__spesenabrechnung__pdf';
  }
}



/**
 * Implements hook_form_alter().
 */
function zivi_spesen_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  if ($form_id === 'user_login_form') {
    $form['name']['#attributes']['placeholder'] = t('Username');
    $form['name']['#description'] = '';
    $form['name']['#attributes']['class'][] = 'appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm';
    
    $form['pass']['#attributes']['placeholder'] = t('Password');
    $form['pass']['#description'] = '';
    $form['pass']['#attributes']['class'][] = 'appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm';

    $form['actions']['submit']['#attributes']['class'][] = 'w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500';
    $form['#submit'][] = 'zivi_spesen_user_login_form_submit';
  }

  if ($form_id === 'node_spesenabrechnung_form' || $form_id === 'node_spesenabrechnung_edit_form') {
    $form['#attached']['library'][] = 'zivi_spesen/calculator';

    // Add a container for the live preview.
    $form['calculation_preview'] = [
      '#type' => 'markup',
      '#markup' => '<div id="spesen-preview" class="spesen-preview"></div>',
      '#weight' => 10,
    ];
  }
}

/**
 * Implements hook_ENTITY_TYPE_create() for node entities.
 */
function zivi_spesen_node_create(NodeInterface $node) {
  if ($node->getType() !== 'spesenabrechnung') {
    return;
  }

  // Set default date range to current month.
  $start_date = new DrupalDateTime('first day of this month');
  $end_date = new DrupalDateTime('last day of this month');
  
  $node->set('field_date_range', [
    'value' => $start_date->format('Y-m-d'),
    'end_value' => $end_date->format('Y-m-d'),
  ]);

  // Pre-populate standard expense items.
  $rates = [
    'Taschengeld' => 7.50,
    'Morgenessen' => 4.00,
    'Mittagessen' => 9.00,
    'Nachtessen' => 7.00,
  ];

  // Calculate initial days (inclusive).
  $interval = $start_date->diff($end_date);
  $days = $interval->days + 1;

  foreach ($rates as $type => $rate) {
    $quantity = $days;
    // Special case: Nachtessen is Total Days - 1
    if ($type === 'Nachtessen') {
      $quantity = max(0, $days - 1);
    }

    $paragraph = Paragraph::create([
      'type' => 'expense_line_item',
      'field_item_type' => $type,
      'field_rate' => $rate,
      'field_quantity' => $quantity,
      'field_total_amount' => $rate * $quantity,
    ]);
    // We don't save the paragraph here because the node isn't saved yet.
    // But for the form to show it, it needs to be in the field.
    // Actually, for the "Add" form, we usually need to rely on the form state or just setting it on the node object works if it's a fresh create?
    // Yes, setting it on the node object passed to the form works.
    $node->get('field_expense_items')->appendItem($paragraph);
  }
}

/**
 * Implements hook_node_presave().
 */
/**
 * Implements hook_node_presave().
 */
function zivi_spesen_node_presave(NodeInterface $node) {
  if ($node->getType() !== 'spesenabrechnung') {
    return;
  }

  // Logic moved to ExpenseReportForm.php to avoid conflicts.
  // The form handles full regeneration of items and total calculation.
  // Keeping this hook empty for now to prevent double-calculation/overwriting.
}

/**
 * Custom submit handler for user login form.
 */
function zivi_spesen_user_login_form_submit($form, FormStateInterface $form_state) {
  $form_state->setRedirect('zivi_spesen.dashboard');
}
